---
title: webpack
date: 2020-07-30 00:00:00
categories: 'webpack'
tags:
- webpack
---

# webpack 的搭建

webpack 是一个现代 JavaScript 应用程序的静态模块打包器(module bundle)。当 webpack 处理应用程序时，
它会递归地构建一个依赖关系图(dependency graph)，
其中包含应用程序需要的每个模块，然后将所有这些模块打包成一个或多个 bundle

# webpack的五个核心 

 - 1、入口(entry)
 
    > 单入口(SPA): 如果传入一个字符串或者字符串数组， chunk会被命名为main
    > 多入口(MPA)：如果传入一个对象，那么每个对象的key会是chunk的名称
 - 2、出口(output)

        出口命名 filename : ‘[name].bundle.js’
        
 - 3、模式(mode)
     Development: 
     会将process.env.NODE_ENV 的值设置为 development 启用 NamedChunkPlugins 和 NameModelsPlugins
     也即是说当前模式会默认为我们设置
     Production:
     会将process.env.NODE_ENV 的值设置为production , 当设置生产模式时候， webpack会默认帮我们压缩js代码，开启树摇等相关
 - 4、插件(plugins)
 
    loader 被用于转换某些类型的模块，而插件则可以用于执行范围更广的任务。插件的范围包括，从打包优化和压缩，一直到重新定义环境中的变量， 插件都是构造函数，引入后需要被new 关键字调用创建对应的实例

 - 5、loader
 
     loader 可以将所有类型的文件转换为 webpack 能够处理的有效的模块， 比如我们的less，sass，js的更高级语法，eslint， 图片，字体资源
     常用的loader —> babel-loader less-loader sass-loader ( node-sass ) eslint-loader url-loader file-loader

# source map
  
  *source map的几种风格、开发模式下配置devtool: source-map，生产模式不建议。*

- eval: 构建速度最快、但是并不能显示对用错误代码行数

- eval-source-map: 初始化source map 会较慢，但是重新构建是提供比较快的速度，并且生成实际的文件，能够正常映射实际的原始代码，所以相比其他是是开发环境最优的选择

- eval-cheap-source-map: 类似eval-source-map 是低开销的source map 因为没有生成列映射，只是映射了行树。会忽略源自loader的source map 并且仅显示转译后的代码。

- eval-cheap-module-source-map: loader的source map 会得到更好的处理结果。loader source map会被简化成每行一个映射（mapping）

# 开发模式配置
```
"use strict";

const { join } = require("path");
const HtmlWebpackPlugin = require("html-webpack-plugin");
const { CleanWebpackPlugin } = require("clean-webpack-plugin");
const webpack = require('webpack')
const common = require('./webpack.common')
const { merge } = require('webpack-merge')
 const config = {
    mode: "development",
    devtool: 'eval',
    entry: ["./src/index.js", "./public/index.html"],
    output: {
        path: join(__dirname, "./dist"),
        filename: "[name].bundle.js"
    },
    module: {
        rules: [
            {
                test: /\.(js|jsx)$/,
                use: {
                    loader: "babel-loader"
                }
            },
            {
                test: [/\.css$/, /\.less$/],
                use: [
                    "style-loader",
                    {
                        loader: "css-loader",
                        options: {
                            modules: true,
                            esModule: true
                        }
                    },
                    {
                        loader: "postcss-loader",
                        options: {
                            ident: "postcss",
                            plugins: (loader) => [
                                require("postcss-import")({ root: loader.resourcePath }),
                                require("postcss-cssnext")(),
                                require("cssnano")(),
                                require("postcss-preset-env")()
                            ]
                        }
                    },
                    "less-loader"
                ]
            },
            {
                test: [/\.css$/, /\.less$/],
                include: join(__dirname, "src/styles/global"),
                use: [
                    "style-loader",
                    "css-loader",
                    {
                        loader: "postcss-loader",
                        options: {
                            ident: "postcss",
                            plugins: (loader) => [
                                require("postcss-import")({ root: loader.resourcePath }),
                                require("postcss-cssnext")(),
                                require("cssnano")(),
                                require("postcss-preset-env")()
                            ]
                        }
                    },
                    "less-loader"
                ]
            },
            {
                test: [/\.png$/, /\.jpg$/, /\.jpeg$/, /\.gif$/, /\.webp$/],
                use: [
                    {
                        loader: "url-loader",
                        options: {
                            limit: 1024 * 10, // 文件小于10kb，输出DataUrl
                            outputPath: "images", // 该路径相对于html输出路径
                            publicPath: "../../images",
                            name: "[name].[ext]",
                            esModule: false
                        }
                    }
                ]
            },
            {
                test: /\.(woff|woff2|eot|ttf|otf)$/,
                use: [
                    "file-loader"
                ]
            },
            {
                test: /\.html$/,
                loader: 'html-loader'
            }
        ]
    },
    plugins: [
        new CleanWebpackPlugin(),
        new HtmlWebpackPlugin(
            {
                template: "./public/index.html",
                filename: "index.html",
                inject: "body"
            }
        ),
        new webpack.HotModuleReplacementPlugin()
    ],
    devServer: {
        port: 8888,
        hot: true,
        open: true,
        contentBase: "./",
        clientLogLevel: 'none', //去掉控制台日志信息
        quiet: true //除了一些基本信息外，其他内容都不要显示
    }
};
module.exports = merge(common, config)

```
 
# 生产模式配置
```
const { join } = require("path");
const MiniCssExtractPlugin = require("mini-css-extract-plugin");
const HtmlWebpackPlugin = require("html-webpack-plugin");
const OptimizeCssAssetsWebpackPlugin = require("optimize-css-assets-webpack-plugin");
const { CleanWebpackPlugin } = require("clean-webpack-plugin");
// const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')
// const Smp = new SpeedMeasurePlugin();
const WorkboxWebpackPlugin = require("workbox-webpack-plugin");
const common = require("./webpack.common");
const { merge } = require("webpack-merge");

process.env.NODE_ENV = "production";

const config = {
    mode: "production",
    optimization: {
        splitChunks: {
            chunks: "all",
            cacheGroups: {
                common: {
                    test: /[\\/]node_modules[\\/]/,
                    name: "vendor",//提取后的代码不需要修改hash添加
                    enforce: true
                }
            }
        },
        runtimeChunk: {
            name: entryPoint => `runtime~${entryPoint.name}`
        }
    },
    module: {
        rules: [
            //eslint
            {
                test: /\.(js|jsx)$/,
                exclude: /node_modules/,
                enforce: "pre",
                use: [
                    {
                        loader: "eslint-loader",
                        options: {
                            fixed: true
                        }
                    }
                ]
            },
            {
                oneOf: [
                    {
                        test: /\.(js|jsx)$/,
                        include: join(__dirname, "src"),
                        use: [
                            {
                                loader: "babel-loader"
                            }
                        ]
                    },
                    //css
                    {
                        test: /\.css$/,
                        include: join(__dirname, "src"),
                        use: [
                            {
                                loader: MiniCssExtractPlugin.loader,
                                options: {
                                    modules: true,
                                    options: {
                                        publicPath: "./css"
                                    }
                                }
                            },
                            {
                                loader: "postcss-loader",
                                options: {
                                    ident: "postcss",
                                    plugins: (loader) => [
                                        require("postcss-import")({ root: loader.resourcePath }),
                                        require("postcss-cssnext")(),
                                        require("cssnano")(),
                                        require("postcss-preset-env")()
                                    ]
                                }

                            },
                            {
                                loader: "css-loader",
                                options: {
                                    modules: true,
                                    esModule: true
                                }
                            }
                        ]
                    },
                    //less
                    {
                        test: /\.less$/,
                        include: join(__dirname, "src"),
                        use: [
                            {
                                loader: MiniCssExtractPlugin.loader,
                                options: {
                                    publicPath: "./css"
                                }
                            },
                            {
                                loader: "css-loader",
                                options: {
                                    modules: {
                                        mode: "local",
                                        exportGlobals: true,
                                        localIdentName: "[name]__[local]__[hash:base64:5]",
                                        context: join(__dirname, "src"),
                                        hashPrefix: "my-custom-hash"
                                    },
                                    esModule: true
                                }
                            },
                            {
                                loader: "postcss-loader",
                                options: {
                                    ident: "postcss",
                                    plugins: (loader) => [
                                        require("postcss-import")({ root: loader.resourcePath }),
                                        require("postcss-cssnext")(),
                                        require("cssnano")(),
                                        require("postcss-preset-env")()
                                    ]
                                }

                            },
                            "less-loader"
                        ]
                    },
                    //image
                    {
                        test: [/\.png$/, /\.jpg$/, /\.jpeg$/, /\.gif$/, /\.webp$/],
                        include: join(__dirname, "src"),
                        use: [
                            {
                                loader: "url-loader",
                                options: {
                                    limit: 1024 * 8, // 文件小于10kb，输出DataUrl
                                    outputPath: "images", // 该路径相对于html输出路径
                                    publicPath: "./images",
                                    name: "[hash:10].[ext]",
                                    esModule: false
                                }
                            }
                        ]
                    },
                    //font
                    {
                        test: /\.(woff|woff2|eot|ttf|otf)$/,
                        include: join(__dirname, "src"),
                        use: [
                            "file-loader"
                        ]
                    },
                    //html
                    {
                        test: /\.html$/,
                        include: join(__dirname, "src"),
                        loader: "html-loader"
                    }
                ]

            }
        ]
    },
    plugins: [
        new CleanWebpackPlugin(),
        new HtmlWebpackPlugin(
            {
                template: "./public/index.html",
                filename: "index.html",
                hash: true,
                minify: {
                    collapseWhitespace: true,
                    removeComments: true
                }
            }
        ),
        new MiniCssExtractPlugin(
            {
                filename: "css/[name].[contentHash:4].css"
            }
        ),
        new OptimizeCssAssetsWebpackPlugin(),
        new WorkboxWebpackPlugin.GenerateSW({
            clientsClaim: true,
            skipWaiting: true

        })
    ]
    // stats: 'minimal'
};

module.exports = merge(common, config);

```

# 公共配置
```

const { join } = require('path')
const WebpackBar = require('webpackbar')

module.exports = {
    entry: "./src/index.js",
    output: {
        path: join(__dirname, "./dist"),
        filename: "js/[name].[contentHash:4].bundle.js"
    },
    plugins: [
        new WebpackBar()
    ],
    resolve: {
        alias: {
            "@": join(__dirname, "./src"),
            "@assets": join(__dirname, "./src/assets"),
            "@components": join(__dirname, "./src/components"),
            "@layouts": join(__dirname, "./src/layouts"),
            "@pages": join(__dirname, "./src/pages"),
            "@router": join(__dirname, "./src/router"),
            "@services": join(__dirname, "./src/services"),
            "@store": join(__dirname, "./src/store"),
            "@utils": join(__dirname, "./src/utils")
        },
        extensions: [".json", ".js", ".jsx", ".ts", ".tsx", ".css", ".less", "scss", ".styl"],
        mainFiles: ["index"],
        modules: [join(__dirname, "src"), "node_modules"]
    },
    externals: {
        jquery: "Jquery"
    }
};

```

# .babelrc 配置
```angular2
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "safari": "11.1"
        },
        "useBuiltIns": "usage",
        "corejs": {
          "version": 3
        }
      }
    ],
    "@babel/preset-react"
  ],
  "plugins": [
    "react-hot-loader/babel",
    "@babel/plugin-proposal-optional-chaining",
    [
      "@babel/plugin-transform-runtime",
      {
        "corejs": {
          "version": 3
        }
      }
    ],
    [
      "@babel/plugin-proposal-decorators",
      {
        "legacy": true
      }
    ],
    "@babel/plugin-proposal-class-properties"
  ]
}


```

# .eslintrc 配置
```
'use strict';

module.exports = {
    extends: ['airbnb', 'prettier', 'plugin:eslint-comments/recommended', 'prettier/react'],
    plugins: ['eslint-comments', 'unicorn', 'react-hooks', 'react'],
    parser: 'babel-eslint',
    env: {
        browser: true,
    },
    rules: {
        'no-restricted-syntax': 0,
        'react/jsx-wrap-multilines': 0,
        'react/prop-types': 0,
        'react/forbid-prop-types': 0,
        'react/jsx-one-expression-per-line': 0,
        'react/require-default-props': 0,
        'no-void': 0,
        'generator-star-spacing': 0,
        'function-paren-newline': 0,
        'no-restricted-globals': 0,
        'jsx-a11y/no-noninteractive-element-interactions': 0,
        'jsx-a11y/click-events-have-key-events': 0,
        'jsx-a11y/no-static-element-interactions': 0,
        'jsx-a11y/anchor-is-valid': 0,
        'linebreak-style': 0,
        // Too restrictive, writing ugly code to defend against a very unlikely scenario: https://eslint.org/docs/rules/no-prototype-builtins
        'no-prototype-builtins': 'off',
        'import/prefer-default-export': 'off',
        'import/no-default-export': [0, 'camel-case'],
        // Too restrictive: https://github.com/yannickcr/eslint-plugin-react/blob/master/docs/rules/destructuring-assignment.md
        'react/destructuring-assignment': 'off',
        'react/jsx-filename-extension': 'off',
        // Use function hoisting to improve code readability
        'no-use-before-define': ['error', { functions: false, classes: true, variables: true }],
        // Makes no sense to allow type inferrence for expression parameters, but require typing the response
        // Common abbreviations are known and readable
        'unicorn/prevent-abbreviations': 'off',
        'import/no-cycle': 0,
        'react-hooks/rules-of-hooks': 'error', // Checks rules of Hooks

        // issue https://github.com/facebook/react/issues/15204
        'react-hooks/exhaustive-deps': 'off', // Checks effect dependencies
        'object-curly-newline': 0,
        'implicit-arrow-linebreak': 0,
        'operator-linebreak': 0,
        'eslint-comments/no-unlimited-disable': 0,
        'no-param-reassign': 1,
        'no-unexpected-multiline': 'error',
        'import/no-extraneous-dependencies': 0,
        'no-plusplus': [
            'error',
            {
                allowForLoopAfterthoughts: true,
            },
        ],
        'no-nested-ternary': 0,
        'prefer-destructuring': 0,
        'no-unused-expressions': 0,
        'no-inner-declarations': 0,
        'no-console': 0,
        'func-names': 0,
        'react/no-string-refs': 1,
        'no-shadow': 1,
        'no-else-return': 1,
        'import/order': 0,
        'lines-between-class-members': 0,
        'object-shorthand': 0,
        'arrow-body-style': 0,
        'arrow-parens': 0,
        'spaced-comment': 0,
        'react/jsx-boolean-value': 0,
        'dot-notation': 0,
        'jsx-a11y/label-has-associated-control': 0,
        'jsx-a11y/label-has-for': 0,
        'camelcase': 1,
        'no-underscore-dangle': 0,
    },
    settings: {
        // support import modules from TypeScript files in JavaScript files
        'import/resolver': {
            alias: {
                map: [
                    ['@', './src'],
                    ['@utils', './src/utils'],
                    ['@assets', './src/assets'],
                    ['@components', './src/components'],
                    ['@pages', './src/pages'],
                    ['@router', './src/router'],
                    ['@store', './src/store'],
                    ['@services', './src/services'],
                    ['@layouts', './src/layouts'],
                ],
                extensions: [".json", ".js", ".jsx", ".ts", ".tsx", ".css", ".less", "scss", ".styl"],
            },
            node: { extensions: [".json", ".js", ".jsx", ".ts", ".tsx", ".css", ".less", "scss", ".styl"] },
        },
        "react": {
            "createClass": "createReactClass", // Regex for Component Factory to use, //使用组件工厂规则
                                               // default to "createReactClass"
            "pragma": "React",  // Pragma to use, default to "React" 默认使用React语法
            "version": "detect", // React version. "detect" automatically picks the version you have installed. React版本，自动检索你安装的版本
                                 // You can also use `16.0`, `16.3`, etc, if you want to override the detected value. 如果你想重写检索值，你也可以使用16.0，16.3等值。
            "flowVersion": "0.53" // Flow version  //流程版本
        },
        "propWrapperFunctions": [
            // The names of any function used to wrap propTypes, e.g. `forbidExtraProps`. If this isn't set, any propTypes wrapped in a function will be skipped. 任何函数名常常用于包裹propTypes，例如"forbidExtraProps"，如果没有被设置，任何被函数包裹的propType将被忽略。
            "forbidExtraProps",
            {"property": "freeze", "object": "Object"},
            {"property": "myFavoriteWrapper"}
        ],
        polyfills: ['fetch', 'Promise', 'URL', 'object-assign'],
    },
};

```

# .prettierc 配置
```
{
  "singleQuote": true,
  "trailingComma": "es5",
  "printWidth": 100,
  "tabWidth": 2,
  "jsxBracketSameLine": false,
  "overrides": [
    {
      "files": ".prettierrc",
      "options": { "parser": "json" }
    }
  ]
}

```
